<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#1f2937" />
  <meta name="description" content="Pokémon Savage Dungeon - Build and track your Pokémon stats" />
  <title>Pokémon Stat Builder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/png" href="favicon.ico" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="favicon.ico" />
</head>

<body id="page" class="py-10 min-h-screen w-90% min-lg:w-70% flex justify-center items-center transition-colors">

<div class="bg-white shadow-xl rounded-xl p-6 w-full max-w-lg">
  <h1 class="text-2xl font-bold text-center mb-4">Pokémon Savage Dungeon</h1>

  <!-- Selector -->
  <select id="pokemonSelect" class="w-full p-2 border rounded mb-4">
    <option value="">-- Elige Pokémon --</option>
  </select>

  <!-- Level -->
  <div class="mb-4 grid grid-cols-4 gap-2 hidden" id="levelContainer">
    <div>
      <label class="block font-semibold">Nivel</label>
      <div class="flex gap-2 items-center">
        <input id="pokemonLevel" type="number" min="0" max="20" value="0" class="flex-1 p-2 border rounded" />
        <span id="rankDisplay" class="font-semibold text-sm px-3 py-2 rounded bg-gray-200">Novice</span>
      </div>
    </div>
    <div>
      <label class="block font-semibold">Bennies</label>
      <div class="flex gap-2 items-center">
        <input type="number" min="0" max="20" value="0" class="flex-1 p-2 border rounded" />
      </div>
    </div>
  </div>

  <!-- Stats -->
  <div id="stats" class="hidden space-y-2">
    <div id="statRows" class="grid grid-cols-4 gap-2 font-semibold text-sm">
      <span>Stat</span><span>Base</span><span>Bonus</span><span>Final</span>
    </div>
  </div>

  <!-- Items -->
  <label class="block mt-4 font-semibold hidden">Objeto Equipado</label>
  <select id="itemSelect" class="w-full p-2 border rounded mb-4">
    <option value="">-- Elige Item --</option>
  </select>
  <div id="itemDescription" class="hidden"></div>
  <div id="itemUsedContainer" class="hidden mt-2 flex items-center">
    <input type="checkbox" id="itemUsed" class="mr-2" />
    <label for="itemUsed" class="text-sm">Item usado</label>
  </div>

  <!-- Edges -->
  <div id="levelsContainer" class="hidden mt-4">
    <label class="block font-semibold mb-2">Avances</label>
    <div id="levelInputs" class="space-y-2 border rounded p-2 bg-gray-50">
      <div id="level0" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 0:</label>
        <input type="text" id="level_0" class="flex-1 p-1 border rounded text-sm" placeholder="Level 0" />
      </div>
      <div id="level1" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 1:</label>
        <input type="text" id="level_1" class="flex-1 p-1 border rounded text-sm" placeholder="Level 1" />
      </div>
      <div id="level2" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 2:</label>
        <input type="text" id="level_2" class="flex-1 p-1 border rounded text-sm" placeholder="Level 2" />
      </div>
      <div id="level3" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 3:</label>
        <input type="text" id="level_3" class="flex-1 p-1 border rounded text-sm" placeholder="Level 3" />
      </div>
      <div id="level4" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 4:</label>
        <input type="text" id="level_4" class="flex-1 p-1 border rounded text-sm" placeholder="Level 4" />
      </div>
      <div id="level5" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 5:</label>
        <input type="text" id="level_5" class="flex-1 p-1 border rounded text-sm" placeholder="Level 5" />
      </div>
      <div id="level6" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 6:</label>
        <input type="text" id="level_6" class="flex-1 p-1 border rounded text-sm" placeholder="Level 6" />
      </div>
      <div id="level7" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 7:</label>
        <input type="text" id="level_7" class="flex-1 p-1 border rounded text-sm" placeholder="Level 7" />
      </div>
      <div id="level8" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 8:</label>
        <input type="text" id="level_8" class="flex-1 p-1 border rounded text-sm" placeholder="Level 8" />
      </div>
      <div id="level9" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 9:</label>
        <input type="text" id="level_9" class="flex-1 p-1 border rounded text-sm" placeholder="Level 9" />
      </div>
      <div id="level10" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 10:</label>
        <input type="text" id="level_10" class="flex-1 p-1 border rounded text-sm" placeholder="Level 10" />
      </div>
      <div id="level11" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 11:</label>
        <input type="text" id="level_11" class="flex-1 p-1 border rounded text-sm" placeholder="Level 11" />
      </div>
      <div id="level12" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 12:</label>
        <input type="text" id="level_12" class="flex-1 p-1 border rounded text-sm" placeholder="Level 12" />
      </div>
      <div id="level13" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 13:</label>
        <input type="text" id="level_13" class="flex-1 p-1 border rounded text-sm" placeholder="Level 13" />
      </div>
      <div id="level14" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 14:</label>
        <input type="text" id="level_14" class="flex-1 p-1 border rounded text-sm" placeholder="Level 14" />
      </div>
      <div id="level15" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 15:</label>
        <input type="text" id="level_15" class="flex-1 p-1 border rounded text-sm" placeholder="Level 15" />
      </div>
      <div id="level16" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 16:</label>
        <input type="text" id="level_16" class="flex-1 p-1 border rounded text-sm" placeholder="Level 16" />
      </div>
      <div id="level17" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 17:</label>
        <input type="text" id="level_17" class="flex-1 p-1 border rounded text-sm" placeholder="Level 17" />
      </div>
      <div id="level18" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 18:</label>
        <input type="text" id="level_18" class="flex-1 p-1 border rounded text-sm" placeholder="Level 18" />
      </div>
      <div id="level19" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 19:</label>
        <input type="text" id="level_19" class="flex-1 p-1 border rounded text-sm" placeholder="Level 19" />
      </div>
      <div id="level20" class="hidden">
        <label class="w-16 text-sm font-medium">Lvl 20:</label>
        <input type="text" id="level_20" class="flex-1 p-1 border rounded text-sm" placeholder="Level 20" />
      </div>
    </div>
  </div>

  <label class="block mt-4 font-semibold">Inventario</label>
  <textarea id="inventory" class="w-full p-2 border rounded mb-2">  </textarea>

  <!-- Import / Export -->
  <div class="flex gap-2">
    <button id="exportBtn" class="flex-1 bg-green-600 text-white py-2 rounded">
      Exportar Pokémon
    </button>

    <label class="flex-1 bg-blue-600 text-white py-2 rounded text-center cursor-pointer">
      Importar Pokémon
      <input type="file" id="importInput" hidden />
    </label>
  </div>
</div>

<script>
const stats = ["ataque","defensa","ataque_esp","defensa_esp","velocidad","IQ"];
const itemMap = ["objeto","descripcion"];
let pokemonData = [];
let itemData = [];
let currentPokemon = null;

/* ---------- TYPE COLOR MAP ---------- */
const typeGradientColors = {
  Normal: 'from-stone-300 to-stone-400',
  Fire: 'from-red-500 to-orange-500',
  Water: 'from-blue-500 to-cyan-500',
  Electric: 'from-yellow-400 to-amber-400',
  Grass: 'from-green-500 to-lime-500',
  Ice: 'from-cyan-300 to-blue-300',
  Fighting: 'from-red-700 to-red-500',
  Poison: 'from-purple-500 to-fuchsia-500',
  Ground: 'from-amber-600 to-yellow-600',
  Flying: 'from-sky-400 to-indigo-400',
  Psychic: 'from-pink-500 to-rose-500',
  Bug: 'from-lime-600 to-green-600',
  Rock: 'from-stone-500 to-amber-700',
  Ghost: 'from-indigo-700 to-purple-700',
  Dragon: 'from-indigo-600 to-violet-700',
  Dark: 'from-gray-800 to-gray-600',
  Steel: 'from-gray-400 to-slate-500',
  Fairy: 'from-pink-300 to-rose-400'
};

/* ---------- CSV LOAD ---------- */
fetch('pokemon.csv')
  .then(res => res.text())
  .then(text => {
    const lines = text.trim().split('\n');
    const headers = lines.shift().split(',');
    pokemonData = lines.map(l => {
      const values = l.split(',');
      let obj = {};
      headers.forEach((h,i) => obj[h] = values[i]);
      return obj;
    });
    const select = document.getElementById('pokemonSelect');
    pokemonData.forEach(p => {
      const o = document.createElement('option');
      if (p.forma === ' ') {
        o.value = `n_${p.name}`;
        o.textContent = p.name;
      } else {
        o.value = `f_${p.forma}`;
        o.textContent = p.forma;
      }
      select.appendChild(o);
    });
  });

fetch('item.csv')
.then(res => res.text())
.then(text => {
  const lines = text.trim().split('\n');
  const headers = lines.shift().split(',');
  itemData = lines.map(l => {
    const values = l.split(',');
    let obj = {};
    headers.forEach((h,i) => obj[h] = values[i]);
    return obj;
  });
  const select = document.getElementById('itemSelect');
  itemData.forEach(i => {
    const o = document.createElement('option');
    o.value = i.objeto;
    o.textContent = i.objeto;
    select.appendChild(o);
  });
});

/* ---------- SELECT POKÉMON ---------- */
document.getElementById('pokemonSelect').addEventListener('change', e => {
  if (e.target.value.substring(0,2) === 'n_') {
    const name = e.target.value.substring(2);
    currentPokemon = pokemonData.find(p => p.name === name && p.forma === ' ');
  } else if (e.target.value.substring(0,2) === 'f_') {
    const forma = e.target.value.substring(2);
    currentPokemon = pokemonData.find(p => p.forma === forma);
  }
  if (!currentPokemon) return;

  applyTypeTheme(currentPokemon.type1, currentPokemon.type2);
  document.getElementById('levelContainer').classList.remove('hidden');
  document.getElementById('levelsContainer').classList.remove('hidden');
  document.getElementById('pokemonLevel').value = 0;
  updateRankDisplay();
  buildLevelInputs();
  buildStatTable();
});

/* ---------- THEME ---------- */
function applyTypeTheme(type1, type2) {
  const page = document.getElementById('page');
  const g1 = typeGradientColors[type1] || 'from-gray-200 to-gray-300';
  const g2 = type2 && typeGradientColors[type2]
    ? typeGradientColors[type2]
    : g1;

  page.classname = "py-10 min-h-screen min-w-full min-lg:min-w-4xl flex justify-center items-center bg-gradient-to-br " + g1.split(' ')[0]+" " + g2.split(' ')[1] + " transition-colors";
  page.setAttribute('class', page.classname);
}

/* ---------- STAT TABLE ---------- */
function buildStatTable() {
  document.getElementById('stats').classList.remove('hidden');
  const container = document.getElementById('statRows');
  container.innerHTML = '<span>Stat</span><span>Base</span><span>Bonus</span><span>Final</span><hr class="col-span-4 border-t my-1" />';

  stats.forEach(stat => {
    const base = Number(currentPokemon[stat]);
    container.innerHTML += `
      <span class="capitalize">${stat.replace('_',' ')}</span>
      <span>${base}</span>
      <input id="${stat}_bonus" type="number" value="0" class="bonus border p-1 rounded" />
      <span id="${stat}_final" class="final font-semibold">1d${base}</span>
    `;
  });

  stats.forEach(stat => {
    const base = Number(currentPokemon[stat]);
    document.getElementById(`${stat}_bonus`).addEventListener('change', e => {
      const bonus = Number(e.target.value);
      document.getElementById(`${stat}_final`).textContent = `1d${base + bonus}`;
    });
  });
}

/* ---------- LEVEL CHANGE ---------- */
document.getElementById('pokemonLevel').addEventListener('change', () => {
  const level = Number(document.getElementById('pokemonLevel').value);
  updateRankDisplay();
  buildLevelInputs(level);
});

function updateRankDisplay() {
  const level = Number(document.getElementById('pokemonLevel').value);
  let rank = 'Novato';
  if (level > 3) rank= 'Experto';
  if (level > 7) rank= 'Veterano';
  if (level > 11) rank= 'Héroe';
  if (level > 15) rank= 'Leyenda';
  document.getElementById('rankDisplay').textContent = rank;
}

/* ---------- BUILD LEVEL INPUTS ---------- */
function buildLevelInputs(newLevel = 0) {
  const container = document.getElementById('levelInputs');
  
  currentLevel = container.childElementCount;
  
  for (let i = 0; i <= 20; i++) {
    if (i <= newLevel) {
      const levelDiv = document.getElementById(`level${i}`);
      levelDiv.classList.remove('hidden');
    } else {
      const levelDiv = document.getElementById(`level${i}`);
      levelDiv.classList.add('hidden');
    }
  }
}

/* ---------- SELECT ITEM ---------- */
document.getElementById('itemSelect').addEventListener('change', e => {
  currentItem = itemData.find(o => o.objeto === e.target.value);
  if (!currentItem) {
    console.log('no item');
    document.getElementById('itemDescription').classList.add('hidden');
    document.getElementById('itemUsedContainer').classList.add('hidden');
    return;}
  container = document.getElementById('itemDescription');
  container.classList.remove('hidden');
  container.textContent = currentItem["efecto\r"];
  
  const usedContainer = document.getElementById('itemUsedContainer');
  const usedCheckbox = document.getElementById('itemUsed');
  if (currentItem.consumible === 'Si') {
    usedContainer.classList.remove('hidden');
    usedCheckbox.checked = false;
  } else {
    usedContainer.classList.add('hidden');
    usedCheckbox.checked = false;
  }
});

/* ---------- EXPORT ---------- */
document.getElementById('exportBtn').onclick = () => {
  if (!currentPokemon) return;

  const bonuses = [...document.querySelectorAll('.bonus')].map(b => Number(b.value));
  const finals = [...document.querySelectorAll('.final')].map(f => Number(f.textContent));
  
  const levelData = {};
  for (let i = 1; i <= 20; i++) {
    levelData[i] = document.getElementById(`level_${i}`).value;
  }

  const data = {
    name: currentPokemon.name,
    level: Number(document.getElementById('pokemonLevel').value),
    itemSelect: document.getElementById('itemSelect').value,
    itemIsUsed: document.getElementById('itemUsed').checked,
    inventory: document.getElementById('inventory').value,
    levelData: levelData,
    stats: stats.reduce((acc, s, i) => {
      acc[s] = {
        base: Number(currentPokemon[s]),
        bonus: bonuses[i],
        final: finals[i]
      };
      return acc;
    }, {})
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${currentPokemon.name}.json`;
  a.click();
};

/* ---------- IMPORT ---------- */
document.getElementById('importInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    const data = JSON.parse(reader.result);
    console.log('Imported data:', data); 

    document.getElementById('pokemonSelect').value = data.name;
    document.getElementById('pokemonSelect').dispatchEvent(new Event('change'));

    document.getElementById('pokemonLevel').value = data.level || 0;
    updateRankDisplay();

    document.getElementById('itemSelect').value = data.items;
    document.getElementById('itemSelect').dispatchEvent(new Event('change'));

    document.getElementById('itemUsed').checked = data.itemIsUsed;

    document.getElementById('inventory').value = data.inventory;
    
    /*
    if (data.levelData) {
      for (let i = 1; i <= 20; i++) {
        const input = document.getElementById(`level_${i}`);
        if (input) {
          input.value = data.levelData[i] || '';
        }
      }
    }

    stats.forEach((s,i) => {
      const bonusInput = document.querySelectorAll('.bonus')[i];
      bonusInput.value = data.stats[s].bonus;
      bonusInput.dispatchEvent(new Event('change'));
    });
    */
  };
  reader.readAsText(file);
});

/* ---------- SERVICE WORKER REGISTRATION ---------- */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(err => console.log('Service Worker registration failed:', err));
}
</script>

</body>
</html>
